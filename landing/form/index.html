<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kuzmanich Seguros 360 – Solicitud de Cotización</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
      max-width: 720px; margin: 0 auto; padding: 24px;
      background: #121826; color: #f0f4f8;
    }
    h1 { font-size: 1.6rem; color: #0056FF; margin-bottom: 16px; }
    .card {
      background: #1E2433; border: 1px solid #2E374E;
      border-radius: 16px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    label { display:block; margin-top:10px; font-weight:600; }
    input, select, textarea {
      width:100%; margin-top:4px; padding:10px;
      border-radius:8px; border:none; background:#2A3248; color:#fff;
      font-size:0.95rem;
    }
    input:disabled, select:disabled { opacity:.6; }
    button {
      background:#0056FF; color:#fff; border:none;
      padding:12px 18px; border-radius:8px; margin-top:18px;
      cursor:pointer; font-size:1rem; width:100%;
    }
    button:hover { background:#0a67ff; }
    .hint { font-size:0.8rem; color:#b0b8c8; margin-top:4px; }
    .ok { color:#00c853; font-weight:600; }
    .row { display:flex; gap:12px; }
    .row .field { flex:1; }
    .footer { text-align:center; margin-top:24px; font-size:0.85rem; color:#99a; }
  </style>
</head>
<body>

  <h1>Solicitud de Cotización</h1>
  <form id="cotizaForm" class="card">
    <label>Nombre completo</label>
    <input id="nombre" required>

    <label>Teléfono</label>
    <input id="telefono" type="tel" placeholder="+549..." required>

    <label>Email</label>
    <input id="email" type="email" placeholder="tu@email.com" required>

    <label>Ramo</label>
    <select id="ramo" required>
      <option value="">Seleccioná...</option>
      <option value="automotor">Automotor</option>
      <option value="retiro">Retiro</option>
      <option value="vida">Vida</option>
      <option value="hogar">Hogar</option>
    </select>

    <!-- CAMPOS AUTOMOTOR -->
    <div id="autoFields" style="display:none; margin-top:8px">
      <div class="row">
        <div class="field">
          <label>Año</label>
          <select id="auto_anio" required><option value="">Seleccioná...</option></select>
        </div>
        <div class="field">
          <label>Marca</label>
          <select id="auto_marca" required disabled><option value="">Seleccioná...</option></select>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Modelo</label>
          <select id="auto_modelo" required disabled><option value="">Seleccioná...</option></select>
        </div>
        <div class="field">
          <label>Motor</label>
          <select id="auto_motor" required disabled><option value="">Seleccioná...</option></select>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Transmisión</label>
          <select id="auto_transmision" required disabled><option value="">Seleccioná...</option></select>
        </div>
        <div class="field">
          <label>Versión</label>
          <select id="auto_version" required disabled><option value="">Seleccioná...</option></select>
        </div>
      </div>
      <label>DNI del tomador</label>
      <input id="auto_dni" inputmode="numeric" placeholder="Ej: 12555777">
    </div>

    <label>Comentarios (opcional)</label>
    <textarea id="comentarios" rows="2"></textarea>

    <div style="margin-top:10px;">
      <input id="acepta" type="checkbox" required>
      Acepto el uso de mis datos para recibir mi cotización y asesoramiento (Ley 25.326).
    </div>

    <button type="submit">Enviar solicitud</button>
    <p id="okMsg" class="ok" style="display:none;">¡Gracias! Recibimos tu solicitud.</p>

    <button id="btnWsp" type="button" style="display:none; background:#2b73ff;">Enviar a SanCor desde mi WhatsApp</button>
  </form>

  <div class="footer">Kuzmanich Seguros 360 · Atención personalizada</div>

<script>
let VEHICLES = [];

async function loadCatalog() {
  try {
    const res = await fetch("./data/vehiculos.json", { cache:"no-store" });
    VEHICLES = await res.json();
  } catch(e) {
    console.error("Error cargando catálogo:", e);
  }
}

function uniq(a){return [...new Set(a)]}
function fill(sel, arr, ph="Seleccioná...") {
  sel.innerHTML = "";
  const o0=document.createElement("option");o0.value="";o0.textContent=ph;sel.appendChild(o0);
  arr.forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=v;sel.appendChild(o);});
  sel.disabled = arr.length===0;
}

// Selectors
const ramoSel=document.getElementById("ramo");
const autoFields=document.getElementById("autoFields");
const selAnio=document.getElementById("auto_anio");
const selMarca=document.getElementById("auto_marca");
const selModelo=document.getElementById("auto_modelo");
const selMotor=document.getElementById("auto_motor");
const selTrans=document.getElementById("auto_transmision");
const selVer=document.getElementById("auto_version");

// Mostrar campos automotor
ramoSel.addEventListener("change",()=>{
  autoFields.style.display = ramoSel.value==="automotor" ? "block" : "none";
});

// Carga dinámica
selAnio.addEventListener("change",()=>{
  const y=+selAnio.value;
  const brands=uniq(VEHICLES.filter(v=>v.year===y).map(v=>v.brand)).sort();
  fill(selMarca,brands);
  fill(selModelo,[]);fill(selMotor,[]);fill(selTrans,[]);fill(selVer,[]);
});
selMarca.addEventListener("change",()=>{
  const y=+selAnio.value,b=selMarca.value;
  const models=uniq(VEHICLES.filter(v=>v.year===y&&v.brand===b).map(v=>v.model)).sort();
  fill(selModelo,models);
  fill(selMotor,[]);fill(selTrans,[]);fill(selVer,[]);
});
selModelo.addEventListener("change",()=>{
  const y=+selAnio.value,b=selMarca.value,m=selModelo.value;
  const engines=VEHICLES.filter(v=>v.year===y&&v.brand===b&&v.model===m).flatMap(v=>v.engines||[]);
  fill(selMotor,uniq(engines.map(e=>e.name)));fill(selTrans,[]);fill(selVer,[]);
});
selMotor.addEventListener("change",()=>{
  const y=+selAnio.value,b=selMarca.value,m=selModelo.value,em=selMotor.value;
  const eng=VEHICLES.find(v=>v.year===y&&v.brand===b&&v.model===m)?.engines?.find(e=>e.name===em);
  fill(selTrans,eng?eng.transmissions.map(t=>t.name):[]);
  fill(selVer,[]);
});
selTrans.addEventListener("change",()=>{
  const y=+selAnio.value,b=selMarca.value,m=selModelo.value,em=selMotor.value,tr=selTrans.value;
  const eng=VEHICLES.find(v=>v.year===y&&v.brand===b&&v.model===m)?.engines?.find(e=>e.name===em);
  const vers=eng?(eng.transmissions.find(t=>t.name===tr)?.versions||[]):[];
  fill(selVer,vers);
});

(async()=>{await loadCatalog();fill(selAnio,uniq(VEHICLES.map(v=>v.year)).sort((a,b)=>b-a));})();

// Envío del formulario
const form=document.getElementById("cotizaForm");
const okMsg=document.getElementById("okMsg");
const btnWsp=document.getElementById("btnWsp");

form.addEventListener("submit",async(e)=>{
  e.preventDefault();
  const data={
    nombre:form.nombre.value,
    telefono:form.telefono.value,
    email:form.email.value,
    ramo:form.ramo.value,
    comentarios:form.comentarios.value,
    auto_anio:selAnio.value,
    auto_marca:selMarca.value,
    auto_modelo:selModelo.value,
    auto_motor:selMotor.value,
    auto_transmision:selTrans.value,
    auto_version:selVer.value,
    auto_dni:document.getElementById("auto_dni").value
  };
  try{
    await fetch("https://orgkuzmanich.app.n8n.cloud/webhook/lead-ingest",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
    okMsg.style.display="block";
    btnWsp.style.display="block";
  }catch(err){
    alert("Error al enviar: "+err.message);
  }
});

// Enviar mensaje de WhatsApp
btnWsp.addEventListener("click",()=>{
  const txt=`Quiero cotizar un ${selMarca.value} ${selModelo.value} ${selVersion?.value||""} del año ${selAnio.value}, para el DNI ${document.getElementById("auto_dni").value}.`;
  const wspURL=`https://wa.me/5492804641495?text=${encodeURIComponent(txt)}`;
  window.open(wspURL,"_blank");
});
</script>
</body>
</html>
